import{au as x,d as z,aW as p,b9 as v,r as h,c as t,as as O,cb as j,bN as K,S as w,ay as se,cf as Me,cg as We,bO as oe,cY as de,G as $,ba as C,n as V,aN as H,a6 as B,cP as Ge,K as U,cZ as A,c_ as je,cd as ie,q as b,j as Ve,z as He,D as Ke,b5 as I,J as F,w as Ue,ci as qe,aK as D,cl as ge,c$ as ue,d0 as he,az as q}from"./index.b1d62c55.js";import{P as Je}from"./Paginator.42abfdc6.js";var R;(function(e){e[e.Pending=0]="Pending",e[e.Running=1]="Running",e[e.Succeeded=2]="Succeeded",e[e.Canceling=3]="Canceling",e[e.Canceled=4]="Canceled",e[e.Errored=5]="Errored",e[e.Failing=6]="Failing",e[e.Failed=7]="Failed",e[e.WaitingRetry=8]="WaitingRetry",e[e.BeforeRetry=9]="BeforeRetry"})(R||(R={}));const Xe={[R.Failed]:"danger",[R.Succeeded]:"success",[R.Canceled]:"neutral"},Ye=e=>{if(e.role<0)return null;const n=["info","neutral","accent"];return t(ie,{get colorScheme(){return n[e.role]},css:{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"},get children(){return e.name}})},Ze=e=>{const n=z();return t(ie,{get colorScheme(){var s;return(s=Xe[e.state])!=null?s:"info"},get children(){return n(`tasks.state.${e.state}`)}})},l=[{name:"name",textAlign:"left",w:x().role===2?"calc(100% - 660px)":"calc(100% - 540px)"},{name:"creator",textAlign:"center",w:x().role===2?"120px":"0"},{name:"state",textAlign:"center",w:"100px"},{name:"progress",textAlign:"left",w:"160px"},{name:"operation",textAlign:"right",w:"280px"}],Qe=e=>{const n=z(),s=e.done==="undone"?"cancel":"delete",u=e.done==="done"&&e.state===R.Failed,[d,g]=p(()=>v.post(`/task/${e.type}/${s}?tid=${e.id}`)),[m,i]=p(()=>v.post(`/task/${e.type}/retry?tid=${e.id}`)),[f,S]=h(!1),y=e.name.match(e.nameAnalyzer.regex),L=y===null?e.name:e.nameAnalyzer.title(y);return t(w,{get when(){return!f()},get children(){return[t(O,{w:"$full",p:"$2",get children(){return[t(O,{get w(){return l[0].w},spacing:"$1",get children(){return[t(j,{"on:click":o=>{o.stopPropagation()},get checked(){return e.selected},onChange:o=>{e.setSelected(e.id,o.target.checked)}}),t(K,{size:"sm",css:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:L})]}}),t(w,{get when(){return x().role===2},get children(){return t(se,{get w(){return l[1].w},get children(){return t(Ye,{get name(){return e.creator},get role(){return e.creator_role}})}})}}),t(se,{get w(){return l[2].w},get children(){return t(Ze,{get state(){return e.state}})}}),t(Me,{get w(){return l[3].w},trackColor:"$info3",rounded:"$full",size:"sm",get value(){return e.progress},get children(){return t(We,{color:"$info8",rounded:"$md"})}}),t(oe,{get w(){return l[4].w},gap:"$1",get children(){return[t(de,{}),t(w,{get when(){return e.canRetry},get children(){return t($,{disabled:!u,display:u?"block":"none",get loading(){return m()},onClick:async()=>{const o=await i();C(o,()=>{V.info(n("tasks.retry")),S(!0)})},get children(){return n("tasks.retry")}})}}),t($,{colorScheme:"danger",get loading(){return d()},onClick:async()=>{const o=await g();C(o,()=>{V.success(n("global.delete_success")),S(!0)})},get children(){return n(`global.${s}`)}}),t($,{colorScheme:"neutral",onClick:()=>{e.setExpanded(e.id,!e.expanded)},get children(){return H(()=>!!e.expanded,!0)()?n("tasks.fold"):n("tasks.expand")}})]}})]}}),t(w,{get when(){return e.expanded},get children(){return t(B,{css:{wordBreak:"break-all",fontSize:"0.8em"},w:"$full",pl:"$2",pr:"$2",get children(){return[t(Ge,{templateColumns:"min-content 1fr",w:"$full",columnGap:"$4",mb:"$2",get children(){return[t(w,{when:y!==null,get children(){return t(U,{get each(){return Object.entries(e.nameAnalyzer.attrs)},children:o=>[t(A,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return o[0]}}),t(A,{color:"$neutral9",get children(){return o[1](y)}})]})}}),t(A,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return n("tasks.attr.status")}}),t(A,{color:"$neutral9",get children(){return e.status}}),t(w,{get when(){return e.error},get children(){return[t(A,{color:"$danger9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return n("tasks.attr.err")}}),t(A,{color:"$danger9",get children(){return[H(()=>e.error)," "]}})]}})]}}),t(je,{})]}})}})]}})},Ee=e=>{const n=z(),[s,u]=p(()=>v.get(`/task/${e.type}/${e.done}`)),[d,g]=h([]),[m,i]=h("name"),[f,S]=h(!1),y={name:(r,a)=>r.name>a.name?1:-1,creator:(r,a)=>r.creator===a.creator?r.id>a.id?1:-1:r.creator>a.creator?1:-1,state:(r,a)=>r.state===a.state?r.id>a.id?1:-1:r.state>a.state?1:-1,progress:(r,a)=>r.progress<a.progress?1:-1},L=b(()=>(r,a)=>(f()?-1:1)*y[m()](r,a)),o=async()=>{var re,ne;const r=await u(),a={},c={};for(const _ of d())a[_.id]=(re=_.selected)!=null?re:!1,c[_.id]=(ne=_.expanded)!=null?ne:!1;C(r,_=>{var ae;return g((ae=_==null?void 0:_.map(G=>{var le,ce;return{...G,selected:(le=a[G.id])!=null?le:!1,expanded:(ce=c[G.id])!=null?ce:!1}}).sort(L()))!=null?ae:[])})};if(o(),e.done==="undone"){const r=setInterval(o,2e3);Ve(()=>clearInterval(r))}const[we,me]=p(()=>v.post(`/task/${e.type}/clear_done`)),[ye,xe]=p(()=>v.post(`/task/${e.type}/clear_succeeded`)),[ke,_e]=p(()=>v.post(`/task/${e.type}/retry_failed`)),[J,pe]=h(""),[ve,Ce]=h(new RegExp("")),[Se,X]=h(!1);He(()=>{try{Ce(new RegExp(J())),X(!1)}catch{X(!0)}});const[Y,be]=h(x().role!==2),M=b(()=>{const r=ve(),a=Y();return c=>r.test(c.name)&&(!a||c.creator===x().username)}),k=b(()=>d().filter(M())),Z=b(()=>k().map(r=>r.selected).every(Boolean)),Ae=b(()=>k().map(r=>r.selected).some(Boolean)&&!Z()),Fe=(r,a)=>{g(d().map(c=>(c.id===r&&(c.selected=a),c)))},Re=r=>{const a=M();g(d().map(c=>(a(c)&&(c.selected=r),c)))},Q=b(()=>k().map(r=>r.expanded).every(Boolean)),ze=(r,a)=>{g(d().map(c=>(c.id===r&&(c.expanded=a),c)))},Pe=r=>{const a=M();g(d().map(c=>(a(c)&&(c.expanded=r),c)))},E=()=>k().filter(r=>r.selected).map(r=>r.id),[Ie,Oe]=p(()=>v.post(`/task/${e.type}/retry_some`,E())),[Be,Ne]=p(()=>v.post(`/task/${e.type}/${ee}_some`,E())),T=r=>{Object.entries(r).forEach(([a,c])=>{V.error(`${a}: ${c}`)})},[De,Le]=h(1),W=20,ee=e.done==="undone"?"cancel":"delete",te=b(()=>{const r=(De()-1)*W,a=r+W;return k().slice(r,a)}),P=r=>({fontWeight:"bold",fontSize:"$sm",color:"$neutral11",textAlign:r.textAlign}),N=r=>({cursor:"pointer",onClick:()=>{m()===r.name?S(!f()):Ue(()=>{i(r.name),S(!1)}),o()}});return t(B,{w:"$full",alignItems:"start",spacing:"$2",get children(){return[t(K,{size:"lg",get children(){return n(`tasks.${e.done}`)}}),t(O,{gap:"$2",flexWrap:"wrap",get children(){return[t(w,{get when(){return e.done==="done"},get children(){return[t($,{colorScheme:"accent",get loading(){return s()},onClick:o,get children(){return n("global.refresh")}}),t($,{get loading(){return ke()},onClick:async()=>{const r=await _e();C(r,()=>o())},get children(){return n("tasks.retry_failed")}}),t($,{colorScheme:"danger",get loading(){return we()},onClick:async()=>{const r=await me();C(r,()=>o())},get children(){return n("global.clear")}}),t($,{colorScheme:"success",get loading(){return ye()},onClick:async()=>{const r=await xe();C(r,()=>o())},get children(){return n("tasks.clear_succeeded")}})]}}),t(w,{get when(){return e.canRetry},get children(){return t($,{colorScheme:"primary",get loading(){return Ie()},onClick:async()=>{const r=await Oe();C(r,a=>{T(a),o()})},get children(){return n("tasks.retry_selected")}})}}),t($,{colorScheme:"warning",get loading(){return Be()},onClick:async()=>{const r=await Ne();C(r,a=>{T(a),o()})},get children(){return n(`tasks.${ee}_selected`)}}),t(Ke,{width:"auto",get placeholder(){return n("tasks.filter")},get value(){return J()},onInput:r=>pe(r.target.value),get invalid(){return Se()}}),t(w,{get when(){return x().role===2},get children(){return t(j,{get checked(){return Y()},onChange:r=>be(r.target.checked),get children(){return n("tasks.show_only_mine")}})}})]}}),t(B,{w:{"@initial":"1024px","@lg":"$full"},overflowX:"auto",shadow:"$md",rounded:"$lg",spacing:"$1",p:"$1",get children(){return[t(O,{class:"title",w:"$full",p:"$2",get children(){return[t(O,{get w(){return l[0].w},spacing:"$1",get children(){return[t(j,{get disabled(){return k().length===0},get checked(){return Z()},get indeterminate(){return Ae()},onChange:r=>Re(r.target.checked)}),t(I,F(()=>P(l[0]),()=>N(l[0]),{get children(){return n(`tasks.attr.${l[0].name}`)}}))]}}),t(w,{get when(){return x().role===2},get children(){return t(I,F({get w(){return l[1].w}},()=>P(l[1]),()=>N(l[1]),{get children(){return n(`tasks.attr.${l[1].name}`)}}))}}),t(I,F({get w(){return l[2].w}},()=>P(l[2]),()=>N(l[2]),{get children(){return n(`tasks.attr.${l[2].name}`)}})),t(I,F({get w(){return l[3].w}},()=>P(l[3]),()=>N(l[3]),{get children(){return n(`tasks.attr.${l[3].name}`)}})),t(oe,{get w(){return l[4].w},gap:"$2",get children(){return[t(de,{}),t(I,F(()=>P(l[4]),{get children(){return n(`tasks.attr.${l[4].name}`)}})),t($,{size:"xs",colorScheme:"neutral",onClick:()=>Pe(!Q()),get disabled(){return k().length===0},get children(){return H(()=>!!Q(),!0)()?n("tasks.fold_all"):n("tasks.expand_all")}})]}})]}}),t(U,{get each(){return te()},children:(r,a)=>t(Qe,F(()=>te()[a()],e,{setSelected:Fe,setExpanded:ze}))})]}}),t(Je,{get total(){return k().length},defaultPageSize:W,onChange:r=>{Le(r)}})]}})},nt=e=>{const n=z();return t(B,{w:"$full",alignItems:"start",spacing:"$4",get children(){return[t(K,{size:"xl",get children(){return n(`tasks.${e.type}`)}}),t(B,{w:"$full",spacing:"$2",get children(){return t(U,{each:["undone","done"],children:s=>t(Ee,{get type(){return e.type},done:s,get canRetry(){return e.canRetry},get nameAnalyzer(){return e.nameAnalyzer}})})}})]}})},Te=q("<a></a>"),fe=q("<p></p>"),et=q('<a target="_blank"></a>'),$e=(e,n)=>{const s=(e==="/"?"":e)+n,u=x().base_path==="/"?"":x().base_path,d=s.startsWith(u),[g,m]=h(!1);return d?(()=>{const i=Te.cloneNode(!0);return i.$$mouseout=()=>m(!1),i.$$mouseover=()=>m(!0),D(i,s),ge(f=>{const S=g()?"text-decoration: underline":"",y=s.slice(u.length);return f._v$=ue(i,S,f._v$),y!==f._v$2&&he(i,"href",f._v$2=y),f},{_v$:void 0,_v$2:void 0}),i})():(()=>{const i=fe.cloneNode(!0);return D(i,s),i})()},at=()=>{const e=z(),[n,s]=h(!1);return{regex:/^download (.+) to \((.+)\)$/,title:u=>u[1],attrs:{[e("tasks.attr.offline_download.url")]:u=>(()=>{const d=et.cloneNode(!0);return d.$$mouseout=()=>s(!1),d.$$mouseover=()=>s(!0),D(d,()=>u[1]),ge(g=>{const m=n()?"text-decoration: underline":"",i=u[1];return g._v$3=ue(d,m,g._v$3),i!==g._v$4&&he(d,"href",g._v$4=i),g},{_v$3:void 0,_v$4:void 0}),d})(),[e("tasks.attr.offline_download.path")]:u=>$e("",u[2])}}},lt=()=>{const e=z();return{regex:/^transfer ((?:.*\/)?(.+)) to \[(.+)]$/,title:n=>n[2],attrs:{[e("tasks.attr.offline_download.transfer_src")]:n=>(()=>{const s=fe.cloneNode(!0);return D(s,()=>n[1]),s})(),[e("tasks.attr.offline_download.transfer_dst")]:n=>$e("",n[3])}}};qe(["mouseover","mouseout"]);export{nt as T,lt as a,$e as b,at as g};
