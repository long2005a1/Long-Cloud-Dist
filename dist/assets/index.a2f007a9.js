import{cb as oe,af as C,Y as k,b as K,c7 as g,cc as b,j as re,i as e,I as j,bg as w,cd as ae,ce as ie,cf as le,h as M,a as ce,q as ue,r as u,cg as ge,a$ as A,o as de,aa as he,bU as F,aB as pe,bT as me,S as m,D as P,b1 as z,a9 as fe,U as we,ay as be,G as R,aE as Se,n as f,bh as $e,ch as G}from"./index.93bedee9.js";import{c as _e,h as ke,b as Ce,i as Ie}from"./index.293b5854.js";import{s as ye,g as ve,a as xe}from"./webauthn-json.browser-ponyfill.1c672167.js";const Ee="https://github.com/alist-org/alist";function Le(i){return oe(`${i}-${Ee}`)}const Ae=()=>{const i=C("sso_login_enabled"),I=k("sso_login_platform"),n=C("sso_compatibility_mode"),{searchParams:l,to:S}=K(),o=l.token;o!=null&&o!=""&&(g(o),S(decodeURIComponent(l.redirect||b||"/"),!0));function d(r){const s=r.data;s.token&&(g(s.token),S(decodeURIComponent(l.redirect||b||"/"),!0))}if(window.addEventListener("message",d),re(()=>{window.removeEventListener("message",d)}),i){const r=()=>{const c=w.getUri()+"/auth/sso?method=sso_get_token";if(n){window.location.href=c;return}window.open(c,"authPopup","width=500,height=600")};let s;switch(I){case"Github":s=ke;break;case"Microsoft":s=le;break;case"Google":s=ie;break;case"Dingtalk":s=ae;break;default:s=_e}return e(j,{cursor:"pointer",boxSize:"$8",as:s,p:"$0_5",onclick:r})}},Ue=()=>{const i=k("logo").split(`
`),I=M(i[0],i.pop()),n=ce(),l=ue(()=>`${k("site_title")}`);Ce(l);const S=M("white","$neutral1"),[o,d]=u(localStorage.getItem("username")||""),[r,s]=u(localStorage.getItem("password")||""),[c,U]=u(""),[$,N]=u(!1),[_,q]=ge("remember-pwd","false"),[y,T]=u(!1),[H,J]=A(async()=>y()?w.post("/auth/login/ldap",{username:o(),password:r(),otp_code:c()}):w.post("/auth/login/hash",{username:o(),password:Le(r()),otp_code:c()})),[,V]=A((t,a,h)=>w.post("/authn/webauthn_finish_login?username="+h,JSON.stringify(a),{headers:{session:t}})),[,W]=A(t=>w.get("/authn/webauthn_begin_login?username="+t)),{searchParams:v,to:x}=K(),Y=async()=>PublicKeyCredential&&"isConditionalMediationAvailable"in PublicKeyCredential?await PublicKeyCredential.isConditionalMediationAvailable():!1,Q=C("webauthn_login_enabled"),X=async()=>{N(!$())},O=async t=>{if(!ye()){t||f.error(n("users.webauthn_not_supported"));return}if(t&&!await Y())return;g();const a=t?"":o();!t&&_()==="true"?localStorage.setItem("username",o()):localStorage.removeItem("username");const h=await W(a);$e(h,async D=>{try{const p=ve(D.options);t&&(p.mediation="conditional");const te=await xe(p),ne=await V(D.session,te,a);G(ne,se=>{f.success(n("login.success")),g(se.token),x(decodeURIComponent(v.redirect||b||"/"),!0)})}catch(p){p instanceof Error&&f.error(p.message)}})},E=async()=>{if($())await O();else{_()==="true"?(localStorage.setItem("username",o()),localStorage.setItem("password",r())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const t=await J();G(t,a=>{f.success(n("login.success")),g(a.token),x(decodeURIComponent(v.redirect||b||"/"),!0)},(a,h)=>{!L()&&h===402?Z(!0):f.error(a)})}},[L,Z]=u(!1),B=C("ldap_login_enabled"),ee=k("ldap_login_tips");return B&&T(!0),de(()=>{O(!0)}),e(Se,{zIndex:"1",w:"$full",h:"100vh",get children(){return e(he,{get bgColor(){return S()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"364px"},spacing:"$4",get children(){return[e(F,{alignItems:"center",justifyContent:"space-around",get children(){return[e(pe,{mr:"$2",boxSize:"$12",get src(){return I()}}),e(me,{color:"$info9",fontSize:"$2xl",get children(){return l()}})]}}),e(m,{get when(){return!L()},get fallback(){return e(P,{id:"totp",name:"otp",get placeholder(){return n("login.otp-tips")},get value(){return c()},onInput:t=>U(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&E()}})},get children(){return[e(P,{name:"username",get placeholder(){return n("login.username-tips")},get value(){return o()},onInput:t=>d(t.currentTarget.value)}),e(m,{get when(){return!$()},get children(){return e(P,{name:"password",get placeholder(){return n("login.password-tips")},type:"password",get value(){return r()},onInput:t=>s(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&E()}})}}),e(F,{px:"$1",w:"$full",fontSize:"$sm",color:"$neutral10",justifyContent:"space-between",alignItems:"center",get children(){return[e(z,{get checked(){return _()==="true"},onChange:()=>q(_()==="true"?"false":"true"),get children(){return n("login.remember")}}),e(fe,{color:"$success9",as:we,href:"https://long2024.cn/404.html",children:"\u6682\u4E0D\u63D0\u4F9B\u975E\u7BA1\u7406\u5458\u767B\u5F55\uFF01"})]}})]}}),e(be,{w:"$full",spacing:"$2",get children(){return[e(m,{get when(){return!$()},get children(){return[e(R,{w:"$full",colorScheme:"danger",onClick:()=>{g(),x(decodeURIComponent(v.redirect||b||"/"),!0)},get children(){return n("login.use_guest")}}),e(R,{colorScheme:"warning",w:"$full",onClick:()=>{L()?U(""):(d(""),s(""))},get children(){return n("login.clear")}})]}}),e(R,{colorScheme:"success",w:"$full",get loading(){return H()},onClick:E,get children(){return n("login.login")}})]}}),e(m,{when:B,get children(){return e(z,{w:"$full",get checked(){return y()===!0},onChange:()=>T(!y()),children:ee})}}),e(F,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[e(Ae,{}),e(m,{when:Q,get children(){return e(j,{cursor:"pointer",boxSize:"$8",as:Ie,p:"$0_5",onclick:X})}})]}})]}})}})};export{Ue as default};
