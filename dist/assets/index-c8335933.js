import{cd as le,ap as S,a7 as I,d as H,c8 as b,ce as $,z as q,x as e,I as J,bq as w,cf as ce,cg as ue,ch as ge,r as G,b as de,C as pe,D as p,ci as he,b9 as R,y as me,ak as fe,bV as U,aL as we,bU as be,S as m,Q as O,bb as N,aj as $e,a3 as ke,aI as Ce,V as A,aO as _e,n as f,br as Ie,cj as V}from"./index-ff851c3c.js";import{c as Se,h as ye,b as ve,i as Le}from"./index-8c39f611.js";import{s as xe,g as Ee,a as Fe}from"./webauthn-json.browser-ponyfill-f2f06d6e.js";const Pe="https://github.com/alist-org/alist";function Re(c){return le(`${c}-${Pe}`)}const Ue=()=>{const c=S("sso_login_enabled"),y=I("sso_login_platform"),n=S("sso_compatibility_mode"),{searchParams:u,to:k}=H(),s=u.token;s!=null&&s!=""&&(b(s),k(decodeURIComponent(u.redirect||$||"/"),!0));function h(i){const o=i.data;o.token&&(b(o.token),k(decodeURIComponent(u.redirect||$||"/"),!0))}if(window.addEventListener("message",h),q(()=>{window.removeEventListener("message",h)}),c){const i=()=>{const g=w.getUri()+"/auth/sso?method=sso_get_token";if(n){window.location.href=g;return}window.open(g,"authPopup","width=500,height=600")};let o;switch(y){case"Github":o=ye;break;case"Microsoft":o=ge;break;case"Google":o=ue;break;case"Dingtalk":o=ce;break;default:o=Se}return e(J,{cursor:"pointer",boxSize:"$8",as:o,p:"$0_5",onclick:i})}},ze=()=>{const c=I("logo").split(`
`),y=G(c[0],c.pop()),n=de(),u=pe(()=>`${I("site_title")}`);ve(u);const k=G("white","$neutral1"),[s,h]=p(localStorage.getItem("username")||""),[i,o]=p(localStorage.getItem("password")||""),[g,T]=p(""),[C,Q]=p(!1),[_,W]=he("remember-pwd","false"),[v,z]=p(!1),[X,Y]=R(async()=>v()?w.post("/auth/login/ldap",{username:s(),password:i(),otp_code:g()}):w.post("/auth/login/hash",{username:s(),password:Re(i()),otp_code:g()})),[,Z]=R((t,r,d,P)=>w.post("/authn/webauthn_finish_login?username="+d,JSON.stringify(r),{headers:{session:t},signal:P})),[,ee]=R((t,r)=>w.get("/authn/webauthn_begin_login?username="+t,{signal:r})),{searchParams:L,to:x}=H(),te=async()=>PublicKeyCredential&&"isConditionalMediationAvailable"in PublicKeyCredential?await PublicKeyCredential.isConditionalMediationAvailable():!1,D=S("webauthn_login_enabled"),ne=async()=>{Q(!C())};let a=null;const M=async t=>{if(!xe()){t||f.error(n("users.webauthn_not_supported"));return}if(t&&!await te())return;a==null||a.abort();const r=new AbortController;a=r;const d=t?"":s();!t&&_()==="true"?localStorage.setItem("username",s()):localStorage.removeItem("username");const P=await ee(d,r.signal);Ie(P,async K=>{try{const l=Ee(K.options);l.signal=r.signal,t&&(l.mediation="conditional");const se=await Fe(l),ae=await Z(K.session,se,d,r.signal);V(ae,ie=>{f.success(n("login.success")),b(ie.token),x(decodeURIComponent(L.redirect||$||"/"),!0)})}catch(l){l instanceof Error&&l.name!="AbortError"&&f.error(l.message)}})},B=()=>a==null?void 0:a.abort();me(()=>{D&&(window.addEventListener("beforeunload",B),M(!0))}),q(()=>{a==null||a.abort(),window.removeEventListener("beforeunload",B)});const E=async()=>{if(C())await M();else{_()==="true"?(localStorage.setItem("username",s()),localStorage.setItem("password",i())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const t=await Y();V(t,r=>{f.success(n("login.success")),b(r.token),x(decodeURIComponent(L.redirect||$||"/"),!0)},(r,d)=>{!F()&&d===402?oe(!0):f.error(r)})}},[F,oe]=p(!1),j=S("ldap_login_enabled"),re=I("ldap_login_tips");return j&&z(!0),e(_e,{zIndex:"1",w:"$full",h:"100vh",get children(){return e(fe,{get bgColor(){return k()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"364px"},spacing:"$4",get children(){return[e(U,{alignItems:"center",justifyContent:"space-around",get children(){return[e(we,{mr:"$2",boxSize:"$12",get src(){return y()}}),e(be,{color:"$info9",fontSize:"$2xl",get children(){return u()}})]}}),e(m,{get when(){return!F()},get fallback(){return e(O,{id:"totp",name:"otp",get placeholder(){return n("login.otp-tips")},get value(){return g()},onInput:t=>T(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&E()}})},get children(){return[e(O,{name:"username",get placeholder(){return n("login.username-tips")},get value(){return s()},onInput:t=>h(t.currentTarget.value)}),e(m,{get when(){return!C()},get children(){return e(O,{name:"password",get placeholder(){return n("login.password-tips")},type:"password",get value(){return i()},onInput:t=>o(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&E()}})}}),e(U,{px:"$1",w:"$full",fontSize:"$sm",color:"$neutral10",justifyContent:"space-between",alignItems:"center",get children(){return[e(N,{get checked(){return _()==="true"},onChange:()=>W(_()==="true"?"false":"true"),get children(){return n("login.remember")}}),e($e,{color:"$success9",as:ke,href:"https://long2024.cn/404.html",children:"暂不提供非管理员登录！"})]}})]}}),e(Ce,{w:"$full",spacing:"$2",get children(){return[e(m,{get when(){return!C()},get children(){return[e(A,{w:"$full",colorScheme:"danger",onClick:()=>{b(),x(decodeURIComponent(L.redirect||$||"/"),!0)},get children(){return n("login.use_guest")}}),e(A,{colorScheme:"warning",w:"$full",onClick:()=>{F()?T(""):(h(""),o(""))},get children(){return n("login.clear")}})]}}),e(A,{colorScheme:"success",w:"$full",get loading(){return X()},onClick:E,get children(){return n("login.login")}})]}}),e(m,{when:j,get children(){return e(N,{w:"$full",get checked(){return v()===!0},onChange:()=>z(!v()),children:re})}}),e(U,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[e(Ue,{}),e(m,{when:D,get children(){return e(J,{cursor:"pointer",boxSize:"$8",as:Le,p:"$0_5",onclick:ne})}})]}})]}})}})};export{ze as default};
