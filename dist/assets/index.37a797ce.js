import{cb as ae,af as I,Y as C,b as N,c7 as h,cc as b,j as ie,i as e,I as q,bg as w,cd as le,ce,cf as ue,h as G,a as ge,q as de,r as d,cg as he,a$ as P,o as pe,aa as me,bU as R,aB as fe,bT as we,S as m,D as U,b1 as K,a9 as be,U as Se,ay as $e,G as T,aE as _e,n as f,bh as ke,ch as j}from"./index.3415f43a.js";import{c as Ce,h as Ie,b as ye,i as ve}from"./index.940ed677.js";import{s as xe,g as Ee,a as Le}from"./webauthn-json.browser-ponyfill.1c672167.js";const Ae="https://github.com/alist-org/alist";function Fe(l){return ae(`${l}-${Ae}`)}const Pe=()=>{const l=I("sso_login_enabled"),y=C("sso_login_platform"),n=I("sso_compatibility_mode"),{searchParams:c,to:S}=N(),s=c.token;s!=null&&s!=""&&(h(s),S(decodeURIComponent(c.redirect||b||"/"),!0));function p(a){const o=a.data;o.token&&(h(o.token),S(decodeURIComponent(c.redirect||b||"/"),!0))}if(window.addEventListener("message",p),ie(()=>{window.removeEventListener("message",p)}),l){const a=()=>{const u=w.getUri()+"/auth/sso?method=sso_get_token";if(n){window.location.href=u;return}window.open(u,"authPopup","width=500,height=600")};let o;switch(y){case"Github":o=Ie;break;case"Microsoft":o=ue;break;case"Google":o=ce;break;case"Dingtalk":o=le;break;default:o=Ce}return e(q,{cursor:"pointer",boxSize:"$8",as:o,p:"$0_5",onclick:a})}},Oe=()=>{const l=C("logo").split(`
`),y=G(l[0],l.pop()),n=ge(),c=de(()=>`${C("site_title")}`);ye(c);const S=G("white","$neutral1"),[s,p]=d(localStorage.getItem("username")||""),[a,o]=d(localStorage.getItem("password")||""),[u,O]=d(""),[$,H]=d(!1),[_,J]=he("remember-pwd","false"),[v,B]=d(!1),[V,W]=P(async()=>v()?w.post("/auth/login/ldap",{username:s(),password:a(),otp_code:u()}):w.post("/auth/login/hash",{username:s(),password:Fe(a()),otp_code:u()})),[,Y]=P((t,r,g,F)=>w.post("/authn/webauthn_finish_login?username="+g,JSON.stringify(r),{headers:{session:t},signal:F})),[,Q]=P((t,r)=>w.get("/authn/webauthn_begin_login?username="+t,{signal:r})),{searchParams:x,to:E}=N(),X=async()=>PublicKeyCredential&&"isConditionalMediationAvailable"in PublicKeyCredential?await PublicKeyCredential.isConditionalMediationAvailable():!1,Z=I("webauthn_login_enabled"),ee=async()=>{H(!$())};let k=null;const D=async t=>{if(!xe()){t||f.error(n("users.webauthn_not_supported"));return}if(t&&!await X())return;k==null||k.abort();const r=new AbortController;k=r,h();const g=t?"":s();!t&&_()==="true"?localStorage.setItem("username",s()):localStorage.removeItem("username");const F=await Q(g,r.signal);ke(F,async z=>{try{const i=Ee(z.options);i.signal=r.signal,t&&(i.mediation="conditional");const oe=await Le(i),re=await Y(z.session,oe,g,r.signal);j(re,se=>{f.success(n("login.success")),h(se.token),E(decodeURIComponent(x.redirect||b||"/"),!0)})}catch(i){i instanceof Error&&i.name!="AbortError"&&f.error(i.message)}})},L=async()=>{if($())await D();else{_()==="true"?(localStorage.setItem("username",s()),localStorage.setItem("password",a())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const t=await W();j(t,r=>{f.success(n("login.success")),h(r.token),E(decodeURIComponent(x.redirect||b||"/"),!0)},(r,g)=>{!A()&&g===402?te(!0):f.error(r)})}},[A,te]=d(!1),M=I("ldap_login_enabled"),ne=C("ldap_login_tips");return M&&B(!0),pe(()=>{D(!0)}),e(_e,{zIndex:"1",w:"$full",h:"100vh",get children(){return e(me,{get bgColor(){return S()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"364px"},spacing:"$4",get children(){return[e(R,{alignItems:"center",justifyContent:"space-around",get children(){return[e(fe,{mr:"$2",boxSize:"$12",get src(){return y()}}),e(we,{color:"$info9",fontSize:"$2xl",get children(){return c()}})]}}),e(m,{get when(){return!A()},get fallback(){return e(U,{id:"totp",name:"otp",get placeholder(){return n("login.otp-tips")},get value(){return u()},onInput:t=>O(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&L()}})},get children(){return[e(U,{name:"username",get placeholder(){return n("login.username-tips")},get value(){return s()},onInput:t=>p(t.currentTarget.value)}),e(m,{get when(){return!$()},get children(){return e(U,{name:"password",get placeholder(){return n("login.password-tips")},type:"password",get value(){return a()},onInput:t=>o(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&L()}})}}),e(R,{px:"$1",w:"$full",fontSize:"$sm",color:"$neutral10",justifyContent:"space-between",alignItems:"center",get children(){return[e(K,{get checked(){return _()==="true"},onChange:()=>J(_()==="true"?"false":"true"),get children(){return n("login.remember")}}),e(be,{color:"$success9",as:Se,href:"https://long2024.cn/404.html",children:"\u6682\u4E0D\u63D0\u4F9B\u975E\u7BA1\u7406\u5458\u767B\u5F55\uFF01"})]}})]}}),e($e,{w:"$full",spacing:"$2",get children(){return[e(m,{get when(){return!$()},get children(){return[e(T,{w:"$full",colorScheme:"danger",onClick:()=>{h(),E(decodeURIComponent(x.redirect||b||"/"),!0)},get children(){return n("login.use_guest")}}),e(T,{colorScheme:"warning",w:"$full",onClick:()=>{A()?O(""):(p(""),o(""))},get children(){return n("login.clear")}})]}}),e(T,{colorScheme:"success",w:"$full",get loading(){return V()},onClick:L,get children(){return n("login.login")}})]}}),e(m,{when:M,get children(){return e(K,{w:"$full",get checked(){return v()===!0},onChange:()=>B(!v()),children:ne})}}),e(R,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[e(Pe,{}),e(m,{when:Z,get children(){return e(q,{cursor:"pointer",boxSize:"$8",as:ve,p:"$0_5",onclick:ee})}})]}})]}})}})};export{Oe as default};
